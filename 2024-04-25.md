# 25 April 2024
# or, …

Two roles:

1. One for the GitHub Actions job itself to be able to submit, attach to, and cancel Batch jobs.
2. One for the GitHub Actions job to acquire credentials for and pass into the Nextstrain runtime.

Role 2 has generic permissions to access nextstrain-data,
nextstrain-data-private, etc.  In practice, it's scoped down to a more
restricted set of operations by the inline session policy generated by our
GitHub Actions reusable workflow (pathogen-repo-build.yaml).

Role 2's credentials are written to an envdir and passed into the Nextstrain
runtime via a required `--envdir …` argument that the GitHub workflow caller
must include.  Alternatively, we can add support for a
`NEXTSTRAIN_RUNTIME_ENVDIR` environment variable which is like passing
`--envdir` and make it transparent to the GitHub workflow caller.

<https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect>

```
PUT https://api.github.com/orgs/nextstrain/actions/oidc/customization/sub

{
   "include_claim_keys": [
       "job_workflow_ref",
       "repo"
   ]
}
```

```
PUT https://api.github.com/repos/nextstrain/{repo}/actions/oidc/customization/sub

{"use_default": true}
```

```json
"StringLike": {
  "token.actions.githubusercontent.com:aud": "sts.amazonaws.com",
  "token.actions.githubusercontent.com:sub": "job_workflow_ref:nextstrain/.github/.github/workflows/pathogen-repo-build.yaml@refs/heads/*:repo:nextstrain/*"
}
```
