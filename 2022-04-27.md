# 27 April 2022
# or, dependencies were a mistake

Investigation of

    AttributeError: module 'lib' has no attribute 'X509_V_FLAG_CB_ISSUER_CHECK'

to resolve <https://github.com/nextstrain/cli/issues/171>, which is causing CI
failures for us on GitHub Actions.

Triggered by recent release of `cryptography` version `37.0.0`.

The error arises from combining an old version of `pyopenssl` (at least as old
as `20.0.1`) with a new version of `cryptography` (>= `37.0.0`).  `pyopenssl`
depends on `cryptography`.

With those distributions installed, I was able to reproduce via several means
(using Python 3.8.10, FWIW).  Contrived example:

    python3 -c 'from OpenSSL import crypto'

In the real world though this occurs when `nextstrain-cli` imports `requests`:

    python3 -c 'import requests'

which I could only get to trigger the error if `requests` was also sufficiently
old (at least `2.22.0`).

Any of these alone fix the issue for me once I've reproduced it locally:

  - Uninstall `pyopenssl`.
  
    It's not strictly necessary and isn't automatically installed on a fresh
    venv.  **The GitHub Actions environment has it installed by default,
    however.**

  - Upgrade `requests` to `2.27.1` (a version or two earlier may also be sufficient; didn't test).

  - Upgrade `pyopenssl` to `22.0.0` (a version or two earlier may also be sufficient; didn't test).

  - Downgrade `cryptography` to `<37.0.0`.

Notably, this issue arises in GitHub Actions specifically because its default
Python 3.8.10 in the Ubuntu 20.04 image has both `requests` and `pyopenssl`
pre-installed with old versions, and so they're not upgraded during
`nextstrain-cli` install time (in `ncov-ingest`'s `./bin/setup-github-workflow`
for example).

  - requests is 2.22.0
  - pyopenssl is 20.0.1 (or another problematic version)

Neither of these old libraries are present in a fresh venv created from a
standard Python base install (i.e. without `requests` installed into the
Python's `dist-packages`).

Full reproduction:

    tmp=$(mktemp -d)
    python3 -m venv $tmp
    source $tmp/bin/activate
    python3 -m pip install --upgrade pip setuptools wheel
    python3 -m pip install pyopenssl==20.0.1 requests==2.22.0
    python3 -m pip install nextstrain-cli
    python3 -c 'import requests'
