# 29 October 2021
# or, checking out

## PR land

  - Deployed [grab bag of fixes and improvements](https://github.com/nextstrain/nextstrain.org/pull/411); uneventful
  - [PR submitted for my routing overhaul](https://github.com/nextstrain/nextstrain.org/pull/420)

## üëÄ

  - [module aliasing for better imports](2021-10-27.md)

  - Env var support in Nextstrain CLI
    - `--env FOO` (implemented in terms of an env dir)
    - `--envdir my-env.d`

  - [`nextstrain view` support for narratives](https://github.com/nextstrain/cli/pull/129#issuecomment-928493480)

  - API surface thinking/discussion; see below

  - Buildpacks, etc.

  - Good update story for software + pipeline + data, etc. with `nextstrain
    update`.  Build on buildpacks (images of pipelines).

  - `nextstrain setup`

  - Unified TOC

  - `/fetch/‚Ä¶` security concerns

  - AWS account split

  - [Packaging Con](https://packaging-con.org)?

    - _Unraveling the magic behind Buildpacks_

    - _Building Debian packages the RPM way with debbuild_ ("With debbuild, it‚Äôs
      possible to easily make portable packaging across all major distributions
      with very little pain!" oh?)

    - _Serving and Managing Reproducible Conda Environments via Conda-Store_
      ("Thus conda-store serves the same environment via a filesystem,
      lockfile, pinned yaml specification, conda pack archive, and docker
      image.")

    - _The Promises and Perils of Adopting Static Analysis in Dependency
      Analyzers_ ("The talk is based on my research paper: ‚ÄúPr√§zi: From
      Package-based to Call-based Dependency Networks‚Äù You can find the paper
      here: <https://arxiv.org/abs/2101.09563>").

## API surfaces

### Media types and JSON Schemas

Media types to handle versioning of resource schemas and alternates (sidecars)
for the same dataset.  For example (doesn't have to be exactly this):

| Media type                                          | JSON Schema                           |
| --------------------------------------------------- | --------------------------------------|
| application/vnd.nextstrain.v2.main+json             | augur/data/schema-export-v2.json      |
| application/vnd.nextstrain.v1.meta+json             | augur/data/schema-export-v1-meta.json |
| application/vnd.nextstrain.v1.tree+json             | augur/data/schema-export-v1-tree.json |
| application/vnd.nextstrain.vX.root-sequence+json    | [need to author]                      |
| application/vnd.nextstrain.vY.tip-frequencies+json  | [need to author]                      |

The `application/‚Ä¶+json` syntax is a standard that means "the container format
is application/json".  Almost like subclassing a media type.  `vnd` means
"vendor" and is also a standard.

Fine to keep maintaining these schemas in Augur's repo, but publish them
somewhere predictable and reliable so they can be programmatically referred to
without concern for how/where they're maintained, e.g.
<https://data.nextstrain.org/schemas/augur-export-v2.json>.

Versioning means both that clients can indicate what they want and the server
can indicate what it's returning, even before inspecting the data contents
itself.

### Endpoints

Use existing endpoints (when possible) or slight variations rather than define
wholly new ones.

Provide full, structured functionality for programs using content negotiation,
while also providing convenience routes for humans.  Routes easily map to the
same endpoint functions in the server, so maintenance burden of parallel
routes is minimal.

#### Datasets and narratives

Using `/groups/‚Ä¶` for examples, but if we want this pattern also works fully
for core and staging and with limited read-only functionality for
`/community/‚Ä¶` and `/fetch/‚Ä¶`.

Download, upload, delete via:

    GET + PUT + DELETE /groups/blab/ncov/early-outbreak/root-A  {Accept: application/vnd.nextstrain.v2.main+json}
    GET + PUT + DELETE /groups/blab/ncov/early-outbreak/root-A  {Accept: application/vnd.nextstrain.vX.root-sequence+json}
    GET + PUT + DELETE /groups/blab/ncov/early-outbreak/root-A  {Accept: application/vnd.nextstrain.vY.tip-frequencies+json}
    ...

Convenience routes for humans (and programs that don't need full structure):

    /groups/:groupName/*.json
    /groups/:groupName/*_:sidecar(root-sequence|tip-frequencies).json

      /groups/blab/ncov/early-outbreak/root-A.json
      /groups/blab/ncov/early-outbreak/root-A_root-sequence.json
      /groups/blab/ncov/early-outbreak/root-A_tip-frequencies.json

These convenience routes always return the latest schema versions and don't
require content negotiation.

The convenience routes also open the door for Auspice to (optionally?) use them
to enable for true static, standalone sites (e.g. GitHub Pages, S3, Netlify,
etc) by laying out the filesystem like so:

    groups/
      blab/
        ncov/
          early-outbreak/
            root-A/
              index.html (Auspice entrypoint)
            root-A.json
            root-A_root-sequence.json
            root-A_tip-frequencies.json

For structured API clients, [`Link` headers][] can be sent identifying the alternates:

    Link: </groups/blab/ncov/early-outbreak/root-A>; rel=alternate; type=application/vnd.nextstrain.v2.main+json,
          </groups/blab/ncov/early-outbreak/root-A>; rel=alternate; type=application/vnd.nextstrain.v2.root-sequence+json,
          </groups/blab/ncov/early-outbreak/root-A>; rel=alternate; type=application/vnd.nextstrain.v2.tip-frequencies+json

which can be used to make more resilient clients.


[`Link` headers]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Link

#### Group management

commentary TKTK

  - /groups/:groupName
    - {Accept: application/json}
      - GET
    - {Accept: image/png}
      - GET
      - PUT
      - DELETE
    - {Accept: text/markdown}
      - GET
      - PUT
      - DELETE
  - /groups/:groupName.png
    - GET
    - PUT
    - DELETE
  - /groups/:groupName.md
    - GET
    - PUT
    - DELETE

Later:

  - /groups (a collection)

  - /groups/:groupName
    - {Accept: application/json}
      - PUT (update and creation)
      - PATCH {and also Accept: application/json-patch+json?}
      - DELETE

  - /groups/:groupName/members (a collection)
  - /groups/:groupName/members/:user (a membership)

