# 17 February 2023
# or, Redis upgrade for nextstrain.org

[Notice from Heroku about required upgrade in the next couple months](https://files.slack.com/files-pri/T032AT1ND-F04Q7QTUYN5/_nextstrain-server___action_required__version_approaching_end_of_life._upgrade_now__on_your_redis_add-on__redis_)

[Heroku's documentation](https://devcenter.heroku.com/articles/heroku-redis-version-upgrade), for reference.

## The Plan

 0. Gather information.

        heroku redis:info redis-infinite-42947 | tee redis-info
        heroku addons:info redis-infinite-42947 | tee redis-addon-info

 1. Disabling writes to Redis by detaching it from the apps:

        for app in nextstrain-{dev,canary,server}; do
            heroku addons:detach redis-infinite-42947 -a "$app"
        done

    Instead of entering maintenance mode for the whole site (as suggested by
    Heroku's docs), we'll instead put it into a slightly degraded state by
    removing (read/write) access to Redis.

    This won't affect access to public resources, but will affect anyone with
    an existing login session or establishing a new login session during the
    very brief switchover window:

      - Existing login sessions will be temporarily "forgotten".  They'll be
        "remembered" again after the upgrade.

      - New login sessions established during the upgrade will be permanently
        forgotten after the upgrade.  Anyone unfortunate enough to encounter
        this will need to log in again, although I expect it to affect
        approximately zero people.

    This tradeoff for the majority of the site staying up and available seems
    acceptable to me.

 2. Create the new, upgraded Redis instance as a fork (snapshot copy) of the old:

        heroku addons:create heroku-redis:premium-0 \
            -a nextstrain-server \
            --fork "$(heroku config:get REDIS_URL -a nextstrain-server | perl -pe 's/^redis:/rediss:/; s/(?<=:)(\d+)/$1+1/e')"

 3. Wait for it to be ready:

        heroku addons:info redis-X-N

    Its `State` will change from `creating` to `created`.

    Check that the fork is done:

        heroku redis:info redis-X-N

 4. Compare settings to the previous instance and adjust as necessary:

        heroku redis:info redis-X-N | tee redis-new-info
        git diff redis{,-new}-info
        # make adjustments with other `heroku redis:â€¦` commands

 5. Replace the old Redis instance with the new one:
 
        for app in nextstrain-{dev,canary,server}; do
            heroku redis:promote redis-X-N -a "$app"
        done

 6. Test that your login session is now "remembered" again.

 7. Remove the old Redis instance:

        heroku addons:destroy redis-infinite-42947
