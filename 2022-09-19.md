# 19 September 2022
# or, â€¦

I noticed some weirdness in the design of the Content-Type handling in the
nextstrain.org code base, specifically around `sendSubresource()` and family
and `proxyResponseBodyFromUpstream()`.  It was in the context of the Groups
customizations API work that I first noticed it, but the weirdness is present
in production as well (and was introduced by me, oops).

`proxyResponseBodyFromUpstream()` doesn't set Content-Type, though it does
check that the upstream Content-Type it gets is internally acceptable.  Our
responses for the dataset/narrative RESTful API endpoints do have Content-Types
though, they're just gotten at negotiation time from `contentTypesProvided()`.
This is kinda weird because the design here is that `contentTypesProvided()`
says "yeah, I can do that" before the upstream resource is ever consulted.
This only "works" because the only types we provide are mutually compatible;
they're all explicitly JSON by media type without additional application
constraints on our custom type, so it doesn't matter what the upstream has as
long as it's JSON.

Where it doesn't work anymore is when the media types provided _aren't_
mutually compatible.  Consider group logos, which might be `image/png` or
`image/svg+xml`.  We can't negotiate with the downstream client for `image/png`
but then send `image/svg+xml` and call it `image/png`.

One fix for this might be let `proxyResponseBodyFromUpstream()` set the type
(perhaps conditionally? see patch) and to eschew `contentTypesProvided()` in
some cases where we don't have mutually compatible things?  Or to modify
`contentTypesProvided()` to handle the (common case!) of mutually-incompatible
types, but this requires consultation with handlers.

In retrospect, the design of `contentTypesProvided()` is a little weird and
specific to its first use case.
