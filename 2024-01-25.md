# 25 January 2024
# or, Pathogen repos and `nextstrain build`

_re: <https://github.com/nextstrain/pathogen-repo-template/pull/16>_

```console
$ tree mpox/
mpox/
├── nextstrain-pathogen.yaml
├── ingest/
│   ├── Snakefile
│   └── …
├── phylogenetic/
│   ├── Snakefile
│   ├── config/
│   │   ├── hmpxv1/
│   │   │   ├── config.yaml
│   │   │   └── …
│   │   └── …
│   ├── results/
│   │   ├── hmpxv1/
│   │   │   ├── good_sequences.fasta
│   │   │   └── …
│   │   └── …
│   └── …
├── nextclade/
│   ├── Snakefile
│   └── …
├── shared/
│   ├── reference.fasta
│   └── …
└── …

$ cat nextstrain-pathogen.yaml
---
name: mpox
url: https://github.com/nextstrain/mpox
maintainers:
  - name: the Nextstrain team
    url: https://nextstrain.org

$ nextstrain build mpox/ingest
$ nextstrain build mpox/phylogenetic
$ nextstrain build mpox/phylogenetic \
>   --configfile config/hmpxv1/config.yaml

$ nextstrain build mpox/phylogenetic \
>   results/hmpxv1/good_sequences.fasta \
>   --configfile config/hmpxv1/config.yaml

$ cd mpox/phylogenetic
$ nextstrain build . \
>   --configfile config/hmpxv1/config.yaml

$ nextstrain build . \
>   results/hmpxv1/good_sequences.fasta \
>   --configfile config/hmpxv1/config.yaml
```

How would this work?  By detecting and drawing the filesystem isolation
boundary at the pathogen repo root instead of using the directory given to
`nextstrain build`.  The root is indicated by the presence of
`nextstrain-pathogen.yaml`, which also contains pathogen-level metadata we can
use elsewhere.

What does this look like in a container in practice?

```console
$ nextstrain shell --docker mpox/phylogenetic
Entering the Nextstrain runtime (docker)

Mapped volumes:
  /nextstrain/build is from /home/tom/nextstrain/mpox

Run the command "exit" to leave the runtime.

[Nextstrain] $ pwd
/nextstrain/build/phylogenetic

[Nextstrain] $ tree
/nextstrain/build/phylogenetic/
├── Snakefile
├── config/
│   ├── hmpxv1/
│   │   ├── config.yaml
│   │   └── …
│   └── …
├── results/
│   ├── hmpxv1/
│   │   ├── good_sequences.fasta
│   │   └── …
│   └── …
└── …

[Nextstrain] $ cd ..
[Nextstrain] $ tree -L 1
/nextstrain/build/
├── nextstrain-pathogen.yaml
├── ingest/
├── phylogenetic/
├── nextclade/
├── shared/
└── …
```

Other thoughts:

- The tangle thru which we're trying to find the clearest path here arises
  solely, I believe, from the desire to have files shared between our various
  workflows (e.g. the workflows in `ingest/` and `phylogenetic/` reference
  `shared/`).  If we ditched the premise that they could access them directly,
  the tangle would go away, right?  We could still maintain `shared/` but as
  part of the dev process ensure they're copied into the places in `ingest/`
  and `phylogenetic/` as needed (e.g. by running `make` or
  `./devel/proliferate-shared` or something).

  I'm not saying we _want_ to do this… but it doesn't seem _terrible_ and I'm
  not sure we've seriously considered it?
